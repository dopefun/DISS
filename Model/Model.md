# Model — Физическая симуляция квадрокоптера

##  Описание

Директория содержит компоненты физической модели квадрокоптера для симулятора оценки навыков пилотирования БПЛА. Реализованы математические модели динамики полёта, системы управления, энергопотребления и сенсорики.

---

## Структура директории
```
Model/
├── ControllerManager.cs          # Система управления и стабилизации
├── PropellersController.cs       # Модель винтомоторной группы
├── BatteryManager.cs              # Модель разряда LiPo батареи
├── GroundCheck.cs                 # Детектор столкновения с землёй
├── PropellerCollision.cs          # Обработка столкновений винтов
├── RandomPulseNoise.cs            # Симуляция турбулентности/ветра
├── FreeSpaceDetection.cs          # Детектор препятствий
└── Model.md                      
```

---

## Компоненты

### 1. ControllerManager.cs
**Назначение:** Реализация каскадной системы управления квадрокоптером.

#### Функции:
- **Стабилизация углов** (Angle mode): PI-регулятор для удержания заданного крена/тангажа
- **Ручной режим** (ACRO mode): Прямое управление угловыми скоростями
- **Стабилизация высоты**: Регулятор вертикальной скорости
- **Actual Rates**: Нелинейная кривая чувствительности стиков (Betaflight-подобная)

#### Математическая модель:

**Кватернионный регулятор углов:**
```
q_error = q_est^(-1) ⊗ q_ref
ω_ref = K_p · angle(q_error) · axis(q_error)
```

**Регулятор угловых скоростей:**
```
τ_roll = K_p,roll · (ω_roll,ref + ω_roll,meas)
τ_pitch = K_p,pitch · (ω_pitch,ref + ω_pitch,meas)
τ_yaw = K_p,yaw · (ω_yaw,ref - ω_yaw,meas)
```

**Actual Rates (экспоненциальная кривая):**
```
rate_out = center · x + (max - center) · expo(x)
expo(x) = sign(x) · |x| · (|x|^5 · g + |x| · (1 - g))
```

#### Параметры (Inspector):
| Параметр | Значение | Описание |
|----------|----------|----------|
| `tiltAngle` | 45° | Максимальный угол наклона (Angle mode) |
| `centreRollRate` | 220°/s | Чувствительность в центре стика |
| `maxRollRate` | 800°/s | Максимальная угловая скорость |
| `expoRoll` | 0.5 | Коэффициент экспоненты (0-1) |
| `tiltRateKp` | 10 Hz | Пропорциональный коэффициент PID |
| `verticalSpeedSensitivity` | 6 м/с | Максимальная вертикальная скорость |

#### Связь с паспортом 2.3.3:
- **Направление №4**: Теоретические основы моделирования и управления
- **Направление №5**: Алгоритмическое обеспечение систем управления

---

### 2. PropellersController.cs
**Назначение:** Модель винтомоторной группы (ВМГ) и расчёт сил/моментов.

#### Функции:
- Микширование команд управления в обороты моторов (RPM)
- Расчёт тяги и момента каждого винта
- Модель потребления тока от RPM
- Учёт просадки напряжения батареи

#### Математическая модель:

**Модель тяги (полиномиальная):**
```
F_thrust = a·RPM² + b·RPM + c
```
Коэффициенты (из идентификации):
```
a = 1.597752e-6
b = -9.509696e-4
c = 0
```

**Модель момента сопротивления:**
```
M_drag = a_m·RPM² + b_m·RPM + c_m
```

**Микширование команд (X-конфигурация):**
```
RPM[0] =  pitch + roll - yaw + height
RPM[1] =  pitch - roll + yaw + height
RPM[2] = -pitch - roll - yaw + height
RPM[3] = -pitch + roll + yaw + height
```

**Модель тока мотора (квадратичная зависимость):**
```
I_motor = (RPM² × k_motor) / (U × η)

где:
  k_motor = 0.00000024  (калибровка для 2204 2300kv)
  η = 0.75              (КПД мотора)
  U                     (напряжение батареи)
```

**Пик тока при ускорении:**
```
IF RPM(t) > RPM(t-1):
    I_target = I_motor × 1.5  (на 0.5 сек)
```

**Плавное изменение (инерция ESC):**
```
I_actual(t) = Lerp(I_actual(t-1), I_target, α)
α = 0.1  (коэффициент сглаживания)
```

#### Параметры (Inspector):
| Параметр | Значение | Описание |
|----------|----------|----------|
| `maxRPM` | 12000 об/мин | Максимальные обороты мотора |
| `motorEfficiency` | 0.75 | КПД бесколлекторного мотора |
| `motorCurrentFactor` | 0.00000024 | Коэффициент тока (2204 2300kv, 5") |
| `accelerationFactor` | 1.5 | Пик тока при разгоне (+50%) |
| `_Lx`, `_Ly` | 0.10 м | Расстояние от центра до мотора |

#### Верификация:
**Зависание (RPM ≈ 8200):**
```
I_motor = (8200² × 0.00000024) / (16.8 × 0.75) = 1.28А
I_total = 4 × 1.28 + 1.0 (авионика) = 6.12А ✓
```

#### Связь с паспортом 2.3.3:
- **Направление №8**: Модели и методы идентификации производственных процессов
- **Направление №11**: Методы оптимизации данных в АСУТП

---

### 3. BatteryManager.cs
**Назначение:** Реалистичная модель разряда LiPo батареи.

#### Функции:
- Расчёт напряжения с учётом просадки под нагрузкой
- Динамическое изменение заряда от потребления
- Автоматическое отключение моторов при разряде (safety)

#### Математическая модель:

**Напряжение без нагрузки (линейная модель):**
```
U_noload = U_min·N + (U_max - U_min)·N·(Q/100)

где:
  U_min = 3.0 В   (минимальное напряжение ячейки)
  U_max = 4.2 В   (максимальное напряжение ячейки)
  N               (количество ячеек: 4S, 5S, 6S)
  Q               (заряд в процентах)
```

**Просадка под нагрузкой (закон Ома):**
```
U_actual = U_noload - I·R_internal

где:
  R_internal = 0.05 Ω  (внутреннее сопротивление 4S)
```

**Разряд батареи:**
```
ΔQ = (I·Δt·100) / C

где:
  C = capacity_mAh / 1000  (ёмкость в А·ч)
  Δt                       (время в часах)
```

#### Параметры (Inspector):
| Параметр | Значение | Описание |
|----------|----------|----------|
| `capacity_mAh` | 1500 | Ёмкость батареи (мА·ч) |
| `cellCount` | 4 | Количество ячеек (4S) |
| `internalResistance` | 0.05 Ω | Внутреннее сопротивление |
| `initialCharge` | 100% | Начальный заряд |

#### Пример работы:
```
Полная батарея:  16.8V (4.2V × 4)
Ток 6А:          Просадка 0.3V → 16.5V
Время полёта:    1.5Ah / 6A ≈ 15 минут
```

#### API:
```csharp
float voltage = batteryManager.GetActualVoltage();      // Текущее напряжение
float current = batteryManager.GetCurrentDraw();        // Текущий ток
float charge = batteryManager.GetCurrentCharge();       // Заряд в %
float vPerCell = batteryManager.GetActualVoltagePerCell(); // Напряжение ячейки
```

#### Связь с паспортом 2.3.3:
- **Направление №5**: Алгоритмическое обеспечение систем управления
- **Направление №11**: Методы оптимизации данных в АСУТП

---

### 4. GroundCheck.cs
**Назначение:** Детектор столкновения с землёй и антизалипание.

#### Функции:
- Проверка расстояния до поверхности через `Physics.OverlapSphere`
- Автоматическое выталкивание дрона из земли (при клипинге)
- Предотвращение залипания в коллайдере

#### Алгоритм:
```csharp
1. Найти коллайдеры земли в радиусе checkRadius
2. IF центр дрона ниже поверхности:
       transform.position += Vector3.up × pushHeight
```

#### Параметры (Inspector):
| Параметр | Значение | Описание |
|----------|----------|----------|
| `groundLayer` | Default | Слой земли (LayerMask) |
| `checkRadius` | 0.5 м | Радиус проверки |
| `offset` | 0 м | Смещение точки проверки |

---

### 5. PropellerCollision.cs
**Назначение:** Обработка столкновений винтов с препятствиями.

#### Функции:
- Детектор касания винта (`OnTriggerEnter`)
- Автоматическая остановка мотора при столкновении
- Предотвращение дальнейших повреждений

#### Алгоритм:
```csharp
OnTriggerEnter(Collider other):
    IF other.tag != "Player":
        motorController.StopMotor(motorId)
```

#### Параметры (Inspector):
| Параметр | Тип | Описание |
|----------|-----|----------|
| `motorid` | int | ID мотора (0-3) |
| `motorController` | PropellersController | Ссылка на контроллер ВМГ |

---

### 6. RandomPulseNoise.cs
**Назначение:** Симуляция турбулентности воздуха и порывов ветра.

#### Функции:
- Генерация случайных импульсов силы
- Изменение направления ветра со временем
- Реалистичная модель воздушных возмущений

#### Математическая модель:

**Сила ветра:**
```
F_wind = strength · direction

где:
  strength ~ N(μ, σ²)  (нормальное распределение)
  direction            (случайный вектор в XZ-плоскости)
```

**Параметры шума (Гауссово распределение):**
```
value = N(mean, variance)
N(x) = (1/√(2πσ²)) · exp(-(x-μ)²/(2σ²))
```

#### Параметры (Inspector):
| Параметр | Значение | Описание |
|----------|----------|----------|
| `strength_mean` | 30.0 | Средняя сила ветра (Н) |
| `strength_variance` | 20.0 | Дисперсия силы |
| `pulse_period_mean` | 7 сек | Средний период порыва |
| `wind_change_speed` | 0.05 | Скорость поворота направления |

---

### 7. FreeSpaceDetection.cs
**Назначение:** Детектор препятствий методом raycasting (для автопилота).

#### Функции:
- Батчевый рейкастинг (`RaycastCommand.ScheduleBatch`)
- Визуализация лучей через `LineRenderer`
- Детекция свободного пространства в поле зрения

#### Алгоритм:
```csharp
1. Разбить FOV на numHorizontalPoints лучей
2. Запустить батчевый raycast (параллельно)
3. Визуализировать результаты:
   - Зелёный луч = свободно
   - Красный луч = препятствие
4. Агрегировать данные в numBins "корзин"
```

#### Параметры (Inspector):
| Параметр | Значение | Описание |
|----------|----------|----------|
| `numHorizontalPoints` | 32 | Количество лучей |
| `numBins` | 8 | Количество "корзин" агрегации |
| `fov_degrees` | 90° | Угол обзора |
| `maxDist` | 100 м | Максимальная дальность |
| `displayFreespace` | true | Отображать лучи |

#### Применение:
- Автопилот (избегание препятствий)
- Система предупреждения столкновений
- Оценка навыков пилота (близость к препятствиям)

---

## Взаимосвязи компонентов
```
┌─────────────────────┐
│ ControllerManager   │ ← Команды управления от пилота
└──────────┬──────────┘
           │
           ↓ (roll, pitch, yaw, height commands)
┌─────────────────────┐
│ PropellersController│ ← Микширование в RPM моторов
└──────────┬──────────┘
           │
           ├→ ApplyForces() ────→ Rigidbody (физика Unity)
           │
           └→ GetCurrentConsumption() ─→ BatteryManager
                                          │
                                          ↓
                                    UpdateCharge()
                                    UpdateVoltage()

┌─────────────────────┐
│ GroundCheck         │ → Детект земли → Выталкивание
└─────────────────────┘

┌─────────────────────┐
│ PropellerCollision  │ → Детект касания → StopMotor()
└─────────────────────┘

┌─────────────────────┐
│ RandomPulseNoise    │ → Импульсы силы → Rigidbody.AddForce()
└─────────────────────┘

┌─────────────────────┐
│ FreeSpaceDetection  │ → Raycasting → Данные для автопилота
└─────────────────────┘
```

---

## Связь с диссертацией

### Паспорт специальности 2.3.3
> **Автоматизация и управление технологическими процессами и производствами**

#### Релевантные направления:

**№4. Теоретические основы моделирования и управления:**
- Кватернионная модель ориентации
- Каскадная система стабилизации

**№5. Алгоритмическое обеспечение систем управления:**
- PID-регуляторы углов и скоростей
- Нелинейные кривые Actual Rates

**№8. Модели и методы идентификации:**
- Идентификация модели тяги (полиномиальная аппроксимация)
- Калибровка коэффициентов тока моторов

**№11. Методы оптимизации данных в АСУТП:**
- Батчевый raycasting (оптимизация производительности)
- Модель энергопотребления для критерия эффективности
